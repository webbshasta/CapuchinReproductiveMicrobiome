---
title: "PregStagesAnalysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analysing microbiome change according to stage in pregnancy and lactation

Here we will start with a seqtab.nochim object and a taxa object.

### Handoff to Phyloseq package & saving otu table/taxa table for future use

```{r}
library(phyloseq); library(vegan); library(ggplot2); library(decontam); library(ggpubr); library(gridExtra)
library(lme4)
library(broom)
library(emmeans)
library(multcomp)
library(multcompView)
library(gridExtra)
```


Read in seqtab.nochim and taxa if not already in your environment. 

```{r}
seqtab.nochim <- readRDS("seqtab.nochim.RDS"); rownames(seqtab.nochim)
taxa <- readRDS("taxa.RDS")
taxa.print <- taxa # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)
```

Read in the metadata.

```{r}
metadataStage <- read.csv("SSRMetaData_FemalesControls_22July.csv")
```

```{r}
metadataStage <- metadataStage %>%
                 arrange(., SAMPLE_ID)
row.names(metadataStage) <- metadataStage$SAMPLE_ID #setting the row names for the metadata to be the sample ID

length(row.names(metadataStage)) #374 rows, females + controls
```

#### Matching metadata to sequence table

Check to see if seqtab and metadata are equivalent.

```{r}
indToRemoveFromSeqtab <- setdiff(row.names(seqtab.nochim), metadataStage$SAMPLE_ID) ;indToRemoveFromSeqtab 
length(indToRemoveFromSeqtab) #114 samples need to be removed from the seqtab--these are the males

indToRemoveFromMetadata <- setdiff(metadataStage$SAMPLE_ID, row.names(seqtab.nochim)) ;indToRemoveFromMetadata
length(indToRemoveFromMetadata) #21 these are the samples that we need to remove from the metadata
```

Remove samples from seqtab that are not in the metadata. 

```{r removing samples from seqtab}
seqtab.nochim2 <-seqtab.nochim[!rownames(seqtab.nochim) %in% indToRemoveFromSeqtab, ] ; length(rownames(seqtab.nochim2)) #removing the samples in the list "remove"; 353 rows remain
setdiff(row.names(seqtab.nochim2), metadataStage$SAMPLE_ID) #this should now return 0, since the objects now contain the same sample IDS
seqtab.nochim <- seqtab.nochim2 #saving changes in the original seqtab object
```

Remove samples from metadata that are not in seqtab.

```{r}
metadataStage <- metadataStage %>%
                       filter(., !(SAMPLE_ID %in% indToRemoveFromMetadata)) #; View(SSRFemalesMetaData2) #remove a subset of females from the metadata
                      
setdiff(metadataStage$SAMPLE_ID, row.names(seqtab.nochim)) #confirm the metadata are now matching the seqtab
row.names(metadataStage) <- metadataStage$SAMPLE_ID 
length(row.names(metadataStage)) #353 samples, including controls
```

Removing positive controls (for time being).

```{r remove positive controls}
posControl <- c("PositivePC1", "PositivePC2", "PositivePC3", "substr369s1", "substr369s2", "substr476s")

seqtab.nochim3 <-seqtab.nochim[!rownames(seqtab.nochim) %in% posControl, ] #; View(rownames(seqtab.nochim3))
seqtab.nochim <- seqtab.nochim3
posToRemove <- as.character(setdiff(metadataStage$SAMPLE_ID, row.names(seqtab.nochim3)))
metadataStageNoPos <- metadataStage %>%
                       filter(., !(SAMPLE_ID %in% posToRemove)) #; View(SSRFemalesMetaData3)

rownames(metadataStageNoPos) <- metadataStageNoPos$SAMPLE_ID 
length(rownames(metadataStageNoPos)) #347 samples, including neg controls
```

Creating a phyloseq object.

```{r}
psStage <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), 
               sample_data(metadataStageNoPos), 
               tax_table(taxa))
psStage #18633 taxa and 347 samples

otu_tableGF<-as.matrix(otu_table(seqtab.nochim, taxa_are_rows=FALSE))
write.csv(otu_tableGF,"otu_tableGFStage_22July.csv")
write.csv(taxa,"taxaGFStage_22July.csv")
```

## Microbial ecology: Getting main results

### Running decontam() on a ps object

#### Inspecting library sizes

Be sure your metadata sheet has a column that identifies the sample as control or sample.

```{r}
head(sample_data(psStage))
df <- as.data.frame(sample_data(psStage)) # Put sample_data into a ggplot-friendly data.frame
df$LibrarySize <- sample_sums(psStage)
df <- df[order(df$LibrarySize),]
df$Index <- seq(nrow(df))
ggplot(data=df, aes(x=Index, y=LibrarySize, color=SampleOrControl)) + geom_point()
saveRDS(df, "sampleData_22July.RDS")
```

#### Identify contaminants - prevalence

In this contaminant identification method we’ll use the “prevalence” method. In this method, the prevalence (presence/absence across samples) of each sequence feature in true positive samples is compared to the prevalence in negative controls to identify contaminants.

```{r}
sample_data(psStage)$is.neg <- sample_data(psStage)$SampleOrControl == "Control" #creating a column that displays a logical response to if smaple is control or true sample

contamdf.prev <- isContaminant(psStage, method="prevalence", neg="is.neg") #running the function to test if seqs are contaminants or not
table(contamdf.prev$contaminant)
head(which(contamdf.prev$contaminant))

contamdf.prev05 <- isContaminant(psStage, method="prevalence", neg="is.neg", threshold=0.5) #altering the default threshold

table(contamdf.prev05$contaminant)
```

Let’s take a look at the number of times several of these taxa were observed in negative controls and positive samples.

```{r}
# Make phyloseq object of presence-absence in negative controls and true samples
ps.pa <- transform_sample_counts(psStage, function(abund) 1*(abund>0))
ps.pa.neg <- prune_samples(sample_data(ps.pa)$SampleOrControl == "Control", ps.pa)
ps.pa.pos <- prune_samples(sample_data(ps.pa)$SampleOrControl == "Sample", ps.pa)

# Make data.frame of prevalence in positive and negative samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.pa.pos), pa.neg=taxa_sums(ps.pa.neg),
                      contaminant=contamdf.prev05$contaminant)
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color=contaminant)) + geom_point() +
  xlab("Prevalence (Negative Controls)") + ylab("Prevalence (True Samples)")
```

Samples seem to split pretty cleanly into a branch that shows up mostly in positive samples, and another that shows up mostly in negative controls, and the contaminant assignment has done a good job of identifying those mostly in negative controls.

Removing contaminants from the phyloseq object.

```{r}
contamdf.prev05$contamSeq <- rownames(contamdf.prev05) #making the rownames (the sequences) their own column
#contamdf.prev05$contamSeq <- This should now be your contaminant sequences

toKeepdf <- contamdf.prev05 %>% filter(contaminant == "FALSE") #creating a subset dataframe with only the seqs we want to keep (non-contaminants)
toKeepList <- toKeepdf$contamSeq #creating a character vector of those non-contam seqs
psStage <- prune_taxa(toKeepList, psStage) #removing contaminant taxa 
psStage #18622 taxa and 347 samples
```

Let's rerun the contamination detection step to see if it worked.

```{r}
sample_data(psStage)$is.neg <- sample_data(psStage)$SampleOrControl == "Control"
contamdf.prev05 <- isContaminant(psStage, method="prevalence", neg="is.neg", threshold=0.5) #altering the default threshold
table(contamdf.prev05$contaminant) #It has detected no more contaminants
```

### Pruning controls from the phyloseq object

```{r}
samplesKeep <- prune_samples(sample_data(psStage)$SampleOrControl == "Sample", psStage) #removing all but true samples, since controls were already used to decontaminate
psStage <- samplesKeep #once we know the samples were pruned, we can save that in our main ps object; note that we now have 335 samples, all of which are from female monkeys
psStage #18622 taxa and 335 samples
```

### Removing samples with very few reads

Now that we have decontaminated the samples, and filtered so that we now only have female monkeys, let's check to see if any very low read samples remain. 

```{r}
which(!rowSums(otu_table(psStage)) > 1000) #this returns the samples that have fewer than 1000 reads
```

Let's remove any samples with fewer than 1000 reads from the ps object.

```{r}
toRemove <- c("JA15145-060M", "JA15145-070M", "JA15145-071M", "416-Lunalovegood", "212M", "343-Perdita", "362-Abu", "475-Ed")
psKeep <- prune_samples(!sample_data(psStage)$SAMPLE_ID %in% toRemove, psStage)
psStage <- psKeep; psStage #18622 taxa and 327 samples
```

Let's now remove these same samples from the metadata object, as well as subset it to be samples only

```{r}
metadataStageFilt <- metadataStageNoPos %>% filter(!SAMPLE_ID %in% toRemove)
metadataStageFilt <- metadataStageFilt %>% filter(SampleOrControl == "Sample")
rownames(metadataStageFilt) <- metadataStageFilt$SAMPLE_ID 
length(rownames(metadataStageFilt)) #327 samples
```

### Removing uncharacterized phyla

```{r}
psStage <- subset_taxa(psStage, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))
psStage #18466 taxa and 327 samples
```

### Removing mitochondria and chloroplasts

```{r}
psStage <- subset_taxa(psStage, !is.na(Class) & !Class %in% c("Chloroplast")) 
psStage #18180 taxa and 327 samples

psStage <- subset_taxa(psStage, !is.na(Family) & !Family %in% c("Mitochondria")) 
psStage #15012 taxa and 327 samples
```

### Ensuring we only have females for which we have reproductive status data 

```{r}
metadataStageFilt <- filter(metadataStageFilt, !is.na(ReproductiveStatus)) #pruning samples with no rep state
psStage <- prune_samples(!is.na(sample_data(psStage)$ReproductiveStatus), psStage) #pruning samples with no rep state
psStage #15012 taxa and 313 samples
```

### Alpha-diversity (Shannon) vs. species richness (Chao1)

We are doing this step before filtering for low abundance taxa.

*CHAO1

```{r computation}
adiv<-estimate_richness(psStage,measures=c("Observed","Shannon","Chao1"))
metadataStageFilt$alphadiv<-adiv$Shannon
hist(metadataStageFilt$alphadiv)
metadataStageFilt$chao1<-adiv$Chao1
hist(metadataStageFilt$chao1)
metadataStageFilt$evenness<-adiv$Shannon/log(adiv$Observed)
```

Boxplots with ggplot2

```{r boxplots}

#Before filtering more, we will save this ps object
saveRDS(psStage, "psStage.RDS") #This ps object has all cycling states and stages; it has been decontaminated short read samples have been removed. NA rep statuses have been removed it has not undergone any prevalence filtering

metadataStageFilt$ReproductiveStatus <- factor(metadataStageFilt$ReproductiveStatus, levels = c("Cycling", "Pregnant", "Nursing")) #reording factor levels

write.csv(metadataStageFilt, "metadataStageFilt_prePrevFiltering.csv")
metadataStageFilt <- read.csv("metadataStageFilt_prePrevFiltering.csv")

repState_richness <-ggplot(metadataStageFilt, aes(ReproductiveStatus, chao1,fill=ReproductiveStatus)) +
                           theme_bw() +
                           geom_boxplot(width = 0.5) +
                           scale_fill_manual(values = c("goldenrod1", "darkslategray4", "olivedrab4")) +
                           geom_jitter(alpha = 4/10, height = 0) +
                           xlab("") + ylab("\nSpecies Richness (Chao1)\n") +
                           guides(fill=F,color=F) +
                           theme_minimal() +
                           theme(axis.ticks.x = element_blank(),
                                 axis.text.x = element_blank()); repState_richness

repState_alphaDiv <-ggplot(metadataStageFilt, aes(ReproductiveStatus, alphadiv,fill=ReproductiveStatus)) +
                           theme_bw() +
                           geom_boxplot(width = 0.5) +
                           scale_fill_manual(values = c("goldenrod1", "darkslategray4", "olivedrab4")) +
                           geom_jitter(alpha = 4/10, height = 0) +
                           xlab("") + ylab("\nAlpha Diversity (Shannon)\n") +
                           guides(fill=F,color=F) +
                           theme_minimal() +
                           theme(axis.ticks.x = element_blank()); repState_alphaDiv

SI_figure_StateRichnessAlpha <- ggarrange(repState_richness, repState_alphaDiv,
                                          labels = c("A", "B"),
                                          ncol = 1, nrow = 2, align = "v"); SI_figure_StateRichnessAlpha

ggsave("SI_figure_StateRichnessAlpha.pdf", plot = SI_figure_StateRichnessAlpha, width = 4, height = 6)
```

### Significant differences between groups/rep states

Linear models, anovas, & Post-hoc tests

```{r linear model}
# Chao1
summary(fm1<-aov(log(chao1)~ReproductiveStatus, data=metadataStageFilt))
post_oc<-TukeyHSD(fm1, "ReproductiveStatus", ordered=FALSE); post_oc
SITable_tukeyRichnessState <- as.data.frame(post_oc$ReproductiveStatus)
write.csv(SITable_tukeyRichnessState, "Results/SITable_tukeyRichnessState.csv")

#Shannon
summary(fm1<-aov(log(alphadiv)~ReproductiveStatus, data=metadataStageFilt))
post_oc<-TukeyHSD(fm1, "ReproductiveStatus", ordered=FALSE); post_oc
```

Non-parametric tests & Post-hoc tests

```{r non-para}
# Chao1
kruskal.test(chao1~ReproductiveStatus, data=metadataStageFilt)
#dunnTest(data=SSRFemalesMetaData,chao1~REP_STATE, method="bh")

# Shannon
kruskal.test(alphadiv~ReproductiveStatus, data=metadataStageFilt)
#dunnTest(data=SSRFemalesMetaData,alphadiv~REP_STATE, method="bh")
```

Linear-mixed models

```{r linear mixed model}
# Chao1
fit_chao1 <- lmer(chao1~ ReproductiveStatus + (1 | INDIVIDUAL), data=metadataStageFilt)
Anova(fit_chao1)

# Shannon
fit_shannon <- lmer(alphadiv~ ReproductiveStatus + (1 | INDIVIDUAL),data=metadataStageFilt)
anova(fit_shannon)
```

A useful next step is to explore feature prevalence in the dataset, which we will define here as the number of samples in which a taxa appears at least once. (from f1000 paper)

```{r}
# Compute prevalence of each feature, store as data.frame
prevdf <- apply(X = otu_table(psStage),
                 MARGIN = ifelse(taxa_are_rows(psStage), yes = 1, no = 2),
                 FUN = function(x){sum(x > 0)})
# Add taxonomy and total read counts to this data.frame
prevdf <- data.frame(Prevalence = prevdf,
                      TotalAbundance = taxa_sums(psStage),
                      tax_table(psStage))
```

Are there phyla that are comprised of mostly low-prevalence features? Compute the total and average prevalences of the features in each phylum.

```{r}
plyr::ddply(prevdf, "Phylum", function(df1){cbind(mean(df1$Prevalence),sum(df1$Prevalence))})
```

```{r}
# Define phyla to filter
filterPhyla = c("Deferribacteres", "Dependentiae", "Entotheonellaeota", "Euryarchaeota", "Fibrobacteres", "Hydrogenedentes", "Lentisphaerae", "Omnitrophicaeota", "Synergistetes", "Rokubacteria", "Spirochaetes", "Tenericutes")

# Filter entries with low prevalence of Phylum.
ps1 <- subset_taxa(psStage, !Phylum %in% filterPhyla)
ps1 #14894 taxa and 313 samples
psStage <- ps1
```

Prevalence Filtering

```{r}
# Subset to the remaining phyla
prevdf1 <- subset(prevdf, Phylum %in% get_taxa_unique(psStage, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(psStage),color=Phylum)) +
  # Include a guess for parameter
    geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + 
    geom_point(size = 2, alpha = 0.7) +
    scale_x_log10() +
    xlab("Total Abundance") + 
    ylab("Prevalence [Frac. Samples]") +
    facet_wrap(~Phylum) + 
    theme(legend.position="none")
```

```{r}
#  Define prevalence threshold as 5% of total samples
prevalenceThreshold <- 0.05 * nsamples(psStage)
prevalenceThreshold

# Execute prevalence filter, using `prune_taxa()` function
keepTaxa <- rownames(prevdf1)[(prevdf1$Prevalence >= prevalenceThreshold)]
ps2 <- prune_taxa(keepTaxa, psStage)
ps2 #331 taxa and 313 samples
psStage <- ps2
saveRDS(psStage, "psStage_prev05.RDS") #this ps object is all rep states and stages and filtered low prev phyla and filtered to a 5% prevalence threshold
```

### Agglomerate taxa

When there is known to be a lot of species or sub-species functional redundancy in a microbial community, it might be useful to agglomerate the data features corresponding to closely related taxa. Ideally we would know the functional redundancies perfectly ahead of time, in which case we would agglomerate taxa using those defined relationships and the merge_taxa() function in phyloseq. That kind of exquisite functional data is usually not available, and different pairs of microbes will have different sets of overlapping functions, complicating the matter of defining appropriate grouping criteria.

```{r}
# How many genera would be present after filtering?
length(get_taxa_unique(psStage, taxonomic.rank = "Genus"))

## [1] 144 genera

psGlomStage <- tax_glom(psStage, "Genus", NArm = TRUE)
psGlomStage #143 taxa and 313 samples
```

### Tailoring to different research questions

Abundance value transformation

It is usually necessary to transform microbiome count data to account for differences in library size, variance, scale, etc. The phyloseq package provides a flexible interface for defining new functions to accomplish these transformations of the abundance values via the transform_sample_counts() function. The first argument to this function is the phyloseq object you want to transform, and the second argument is an R function that defines the transformation. The R function is applied sample-wise, expecting that the first unnamed argument is a vector of taxa counts in the same order as the phyloseq object. Additional arguments are passed on to the function specified in the second argument, providing an explicit means to include pre-computed values, previously defined parameters/thresholds, or any other object that might be appropriate for computing the transformed values of interest.

#### Function for plotting abundance according to reproductive state stage

```{r}
plot_abundance_Status <- function(physeq,title = "",
			     Facet = "Order", Color = "Phylum"){
  # Arbitrary subset, based on Phylum, for plotting
  p1f <- subset_taxa(physeq, Phylum %in% c("Firmicutes"))
  mphyseq <- psmelt(p1f)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "ReproductiveStatus",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
    geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}
```

#### Plotting abundance according to reproductive state

```{r}
# Transform to relative abundance. Save as new object.
psGlomRa <- transform_sample_counts(psGlomStage, function(x){x / sum(x)})

plotBefore <- plot_abundance_Status(psGlomStage,"")
plotAfter <- plot_abundance_Status(psGlomRa,"")
# Combine each plot into one graphic.
grid.arrange(nrow = 2, plotBefore, plotAfter)
```

### Beta-diversity (aka community structure/composition)

*PERMANOVA with adonis function
What is the model we want to test?
Many models can be statistically accurate/robust but few are biologically relevant.
Make sure to base your model on biologically relevant question.
Option with repeated measures from many individuals (time-series)

```{r betadiv}
# Create function geo means for Variance Stabilizing Transformation
gm_mean <- function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}

# Variance Stabilizing Transformation (REP_STATE)
test.phyloseq.dds<-phyloseq_to_deseq2(psStage,~ReproductiveStatus)
test.phyloseq.dds <- estimateSizeFactors(test.phyloseq.dds, geoMeans = apply(counts(test.phyloseq.dds), 1, gm_mean))
vst.blind <- DESeq2::varianceStabilizingTransformation(test.phyloseq.dds, blind=TRUE)
vst.blind.Mat <- SummarizedExperiment::assay(vst.blind) # Extract transformed OTU table
vst.blind.Mat<-t(vst.blind.Mat)
vst.blind.Mat[which(vst.blind.Mat<0)]<-0
dists <- dist(t(assay(vst.blind)))

# Computing Bray-Curtis Dissimilarities and PCoA
comm.vst.blind.Mat <- vegdist(vst.blind.Mat, "bray")
PCoA.comm.vst.blind.Mat<-capscale(comm.vst.blind.Mat~1,distance="bray")
PCoA.comm.vst.blind.Mat$CA$eig[1:3]/sum(PCoA.comm.vst.blind.Mat$CA$eig)
PCoA.comm.vst.blind.Mat #this will re-order rownames to be alphabetic, which is not the way they are in the metadata csv. you will need to ensure the metadata file and this object have the same rownames before proceedingto plotting or linear models
eig <- PCoA.comm.vst.blind.Mat$CA$eig

# Portion of total vraiation in community structure explained by each of the main three components
eig[1]/sum(abs(eig)) #0.1820423 
eig[2]/sum(abs(eig)) #0.08577119 
eig[3]/sum(abs(eig)) #0.05733904

# Save scores in dataset tables
mdTest <- metadataStageFilt %>% #ensure that the df is ordered by SAMPLE_ID
          arrange(SAMPLE_ID)
metadataStageFilt <- mdTest

row.names(metadataStageFilt)<-row.names(scores(PCoA.comm.vst.blind.Mat)$sites) 
metadataStageFilt$PCoA1<-scores(PCoA.comm.vst.blind.Mat)$sites[,1]
metadataStageFilt$PCoA2<-scores(PCoA.comm.vst.blind.Mat)$sites[,2]

# PERMANOVA
permanovaMulti<-adonis(comm.vst.blind.Mat ~ ReproductiveStatus + dietType + MONTH + INDIVIDUAL + Rainfall, data=metadataStageFilt, permutations = 2000)
permanova_betaDiv_state <- as.data.frame(permanovaMulti$aov.tab)
write.csv(permanova_betaDiv_state, "Results/permanova_betaDiv_state.csv")
```

### PCoA with ggplot2

Let's visualize beta-diversity in a figure using PCoA with Bray-Curtis distances. 

```{r}
summary(metadataStageFilt)

metadataStageFilt$ReproductiveStatus <- factor(metadataStageFilt$ReproductiveStatus, levels = c("Cycling", "Pregnant", "Nursing")) #changing the order of the levels of rep satus from alphabetical to the order we want them in the plots

betaDivPCoAStatus <- ggplot(metadataStageFilt, aes(PCoA1, PCoA2, color = ReproductiveStatus)) +
                    geom_point(size = 3) +
                    labs(x = "\nPCoA1 [18.2% variance]", y = "PCoA2 [8.57% variance]\n") +
                    scale_color_manual(values = c("goldenrod1", "darkslategray4", "olivedrab4")) +
                    theme_minimal() + 
                    stat_ellipse() +
                    theme(text = element_text(size = 14),
                          legend.title = element_blank(),
                          legend.position = "bottom"); betaDivPCoAStatus

ggsave("SI_figure_betaDivPCoAStatus.pdf", plot = betaDivPCoAStatus, width = 6, height = 4)
```

### Top genera in community

```{r top genera}
GF_comm<-as.matrix(t(otu_table(psGlomRa, taxa_are_rows=FALSE))) #using agglomerated taxa
dim(GF_comm) #143 313
rel_abun_GF<-sweep(GF_comm, 2, apply(GF_comm,2,sum), `/`)
dim(rel_abun_GF)  #143 313
apply(rel_abun_GF,2,sum)
dim(rel_abun_GF)[1]->t
apply(rel_abun_GF,1,sum)
order(apply(rel_abun_GF,1,sum))[(t-9):t]
top10_asvs_GF<-names(apply(rel_abun_GF,1,sum)[order(apply(rel_abun_GF,1,sum))[(t-9):t]])
taxa[top10_asvs_GF,]->top10_taxa_GF
row.names(top10_taxa_GF)<-c(length(row.names(top10_taxa_GF)):1)
paste("asv_",row.names(top10_taxa_GF),sep="")->row.names(top10_taxa_GF)
top10_taxa_GF
# Test for changes in relative abundance in dominant taxa
rel_abun_top10_asvs<-rel_abun_GF[top10_asvs_GF,]
row.names(rel_abun_top10_asvs)<-row.names(top10_taxa_GF)
rel_abun_top10_asvs<-t(rel_abun_top10_asvs)
rel_abun_top10_asvs<-as.data.frame(rel_abun_top10_asvs)
rel_abun_top10_asvs$SAMPLE_ID<-row.names(rel_abun_top10_asvs)
metadataStageFilt$ReproductiveStatus[as.factor(row.names(rel_abun_top10_asvs))]->rel_abun_top10_asvs$ReproductiveStatus
long_rel_abun_top10_asvs<-tidyr::gather(rel_abun_top10_asvs, key=SAMPLE_ID, value=rel_abund, asv_10:asv_1)
dim(long_rel_abun_top10_asvs)
colnames(long_rel_abun_top10_asvs)[2]<-"asv_ID"
long_rel_abun_top10_asvs$plot_ID<-paste(long_rel_abun_top10_asvs$asv_ID,long_rel_abun_top10_asvs$REP_STATE,sep="")
top10df <- as.data.frame(top10_taxa_GF)
top10df$asv_ID <- rownames(top10df)
# Creating log10 column in long_rel_abun_top10_asvs
testLogDf <- long_rel_abun_top10_asvs %>%
             mutate(log10_rel_abund = log10(rel_abund))
for (i in 1:10){
  print(colnames(rel_abun_top10_asvs[i]))
  print(kruskal.test(rel_abun_top10_asvs[,i] ~ ReproductiveStatus, data=rel_abun_top10_asvs))
  #print(dunnTest(rel_abun_top10_asvs[,i] ~ REP_STATE, data=rel_abun_top10_asvs, method="bh"))
}

limitsX2 <- c("asv_1", "asv_2", "asv_3", "asv_4", "asv_5", "asv_6", "asv_7", "asv_8", "asv_9", "asv_10")
breaksX2 <- c("asv_1", "asv_2", "asv_3", "asv_4", "asv_5", "asv_6", "asv_7", "asv_8", "asv_9", "asv_10")
labelsX2 <-  c("Streptococcus", "Bifidobacterium","Rothia","Lachnoclostridium", "Megamonas", "Collinsella", "Escherichia/\nShigella", "Bacteroides", "Enterococcus", "Anaerobiospirillum")

p3<-ggplot(long_rel_abun_top10_asvs, aes(plot_ID,rel_abund*100, fill = ReproductiveStatus))+theme_minimal()+
  geom_boxplot()+
  scale_x_discrete(limits = limitsX2,
                   labels = labelsX2,
                   breaks = breaksX2) +
  xlab("")+ylab("Relative Abundance (%)\n")+
  theme(axis.text.x  = element_text(size=11, color="black", angle=90, vjust = 0.6, hjust = 1, face = "italic"),
        axis.text.y  = element_text(size=11, color="black"),
        axis.title.x  = element_text(size=14, color="black"),
        axis.title.y  = element_text(size=14, color="black"),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
        scale_fill_manual(labels = c("Cycling", "Pregnant", "Nursing"),
                            values = c("goldenrod2", "darkslategray4", "olivedrab4"));p3

ggsave("Figures/topTenGenera_State.pdf", plot = p3, width = 6, height = 4)
```

### Phyloseq to DESeq2 for differential abundance

The function phyloseq_to_deseq2 converts  phyloseq-format microbiome data into a DESeqDataSet with dispersions estimated, using the experimental design formula, also shown (the ~REP_STATE term). Note: The default multiple-inference correction is Benjamini-Hochberg, and occurs within the DESeq function.

#### Exploring differential abundance 

Since we have a variable of interest with >2 levels, and since we are interested in specific changes between different reproductive states, we can use "contrasts" in DESeq2 to explore log fold changes. From the DESeq2 vignette:

"A contrast is a linear combination of estimated log2 fold changes, which can be used to test if differences between groups are equal to zero. The simplest use case for contrasts is an experimental design containing a factor with three levels, say A, B and C. Contrasts enable the user to generate results for all 3 possible differences: log2 fold change of B vs A, of C vs A, and of C vs B. The contrast argument of results function is used to extract test results of log2 fold changes of interest."

```{r}
ps.dSeq <- phyloseq_to_deseq2(psStage, ~ReproductiveStatus) #using unagglomerated  object which includes all taxa except for low prevalence phyla (controls are already filtered out)
ps.dSeq <- estimateSizeFactors(ps.dSeq, geoMeans = apply(counts(ps.dSeq), 1, gm_mean)) #because we have many ASVs that do not appear in all samples, we have to use variance stabilized data to caluculate and visualize differential abundance 
ps.dSeq <- estimateDispersions(ps.dSeq)
ps.dSeq.vst <- getVarianceStabilizedData(ps.dSeq)
dim(ps.dSeq.vst)

psVST <- psStage #psVST will now be the phyloseq object with the variance transformed counts

otu_table(psVST) <- otu_table(ps.dSeq.vst, taxa_are_rows = TRUE) # psVST variable now has the results of DESeq2 variance-stabilization of counts instead of the original counts.
saveRDS(psVST, "Robjects/psVST_state_24July.RDS")

dds.ps <- DESeq(ps.dSeq, test="Wald", fitType = "parametric") 
res <- results(dds.ps) #now we can create contrasts and look at other results in the results table 
```

##### Investigating results 

```{r Preg1 vs Preg2}
res1 <- results(dds.ps, contrast = c("ReproductiveStatus", "Cycling", "Pregnant")) 
res1 <- res1[order(res1$padj, na.last=NA), ]
alpha <- 0.01
sigtab1 <- res1[(res1$padj < alpha), ]
sigtab1 <- cbind(as(sigtab1, "data.frame"), as(tax_table(psVST)[rownames(sigtab1), ], "matrix"))
head(sigtab1)

res2 <- results(dds.ps, contrast = c("ReproductiveStatus", "Pregnant", "Nursing")) 
res2 <- res2[order(res2$padj, na.last=NA), ]
alpha <- 0.01
sigtab2 <- res2[(res2$padj < alpha), ]
sigtab2 <- cbind(as(sigtab2, "data.frame"), as(tax_table(psVST)[rownames(sigtab2), ], "matrix"))
head(sigtab2)

res3 <- results(dds.ps, contrast = c("ReproductiveStatus", "Nursing", "Cycling")) 
res3 <- res3[order(res3$padj, na.last=NA), ]
alpha <- 0.01
sigtab3 <- res3[(res3$padj < alpha), ]
sigtab3 <- cbind(as(sigtab3, "data.frame"), as(tax_table(psVST)[rownames(sigtab3), ], "matrix"))
head(sigtab3)
```


### Reproductive Stages

```{r}
metadataStageFilt <- filter(metadataStageFilt, ReproductiveStage %in% c("Cycling_Pre_Conception", "PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3", "Cycling_PostWeaning")) #subset the 

rownames(metadataStageFilt) <- metadataStageFilt$SAMPLE_ID

psStage <- readRDS("Robjects/psStage.RDS") #reading in the non filtered ps object
psStage <- prune_samples(sample_data(psStage)$ReproductiveStage %in% c("Cycling_Pre_Conception", "PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3", "Cycling_PostWeaning"), psStage)

psStage #15012 taxa and 176 samples
```

### Alpha-diversity (Shannon) vs. species richness (Chao1)

We are doing this step before filtering for low abundance taxa.

*CHAO1

```{r computation}
adiv<-estimate_richness(psStage,measures=c("Observed","Shannon","Chao1"))
metadataStageFilt$alphadiv<-adiv$Shannon
hist(metadataStageFilt$alphadiv)
metadataStageFilt$chao1<-adiv$Chao1
hist(metadataStageFilt$chao1)
metadataStageFilt$evenness<-adiv$Shannon/log(adiv$Observed)
```

Boxplots with ggplot2

```{r boxplots}

#Before filtering more, we will save this ps object
saveRDS(psStage, "psStageAllStages.RDS") #This ps object has all cycling states and stages; it has been decontaminated short read samples have been removed. NA rep statuses have been removed it has not undergone any prevalence filtering

metadataStageFilt$ReproductiveStage <- factor(metadataStageFilt$ReproductiveStage, levels = c("Cycling_Pre_Conception", "PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3", "Cycling_PostWeaning")) #reording factor levels

write.csv(metadataStageFilt, "metadataStageFilt_prePrevFiltering_Stage.csv")
metadataStageFilt <- read.csv("metadataStageFilt_prePrevFiltering.csv")

repStage_richness <-ggplot(metadataStageFilt, aes(ReproductiveStage, chao1,fill=ReproductiveStatus)) +
                           theme_bw() +
                           geom_boxplot(width = 0.5) +
                           scale_fill_manual(values = c("goldenrod1", "darkslategray4", "olivedrab4")) +
                           geom_jitter(alpha = 4/10, height = 0) +
                           xlab("") + ylab("\nSpecies Richness (Chao1)\n") +
                           guides(fill=F,color=F) +
                           theme_minimal() +
                           theme(axis.ticks.x = element_blank(),
                                 axis.text.x = element_blank()); repStage_richness

repStage_alphaDiv <-ggplot(metadataStageFilt, aes(ReproductiveStage, alphadiv,fill=ReproductiveStatus)) +
                           theme_bw() +
                           geom_boxplot(width = 0.5) +
                           scale_fill_manual(values = c("goldenrod1", "darkslategray4", "olivedrab4")) +
                           scale_x_discrete(limit = c("Cycling_Pre_Conception", "PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3", "Cycling_PostWeaning"),
                                            labels = c("Cycling (Pre-Conception)", "Pregnancy Stage 1", "Pregnancy Stage 2", "Pregnancy Stage 3", "Nursing Stage 1", "Nursing Stage 2", "Nursing Stage 3", "Cycling (Post-Weaning)")) +
                           geom_jitter(alpha = 4/10, height = 0) +
                           xlab("") + ylab("\nAlpha Diversity (Shannon)\n") +
                           guides(fill=F,color=F) +
                           theme_minimal() +
                           theme(axis.ticks.x = element_blank(),
                                 axis.text.x = element_text(angle = 45, hjust = 1)); repStage_alphaDiv

Figure_StageRichnessAlpha <- ggarrange(repStage_richness, repStage_alphaDiv,
                                          labels = c("A", "B"),
                                          ncol = 1, nrow = 2, align = "v"); Figure_StageRichnessAlpha

ggsave("Figure_StageRichnessAlpha.pdf", plot = Figure_StageRichnessAlpha, width = 4, height = 6)
```

### Statistical Tests

```{r linear model}
# Chao1
summary(fm1<-aov(log(chao1)~ReproductiveStage, data=metadataStageFilt))
post_oc<-TukeyHSD(fm1, "ReproductiveStage", ordered=FALSE); post_oc
tukeyRichnessStage <- as.data.frame(post_oc$ReproductiveStage)
write.csv(tukeyRichnessStafe, "Results/tukeyRichnessState.csv")

#Shannon
summary(fm1<-aov(log(alphadiv)~ReproductiveStage, data=metadataStageFilt))
post_oc<-TukeyHSD(fm1, "ReproductiveStage", ordered=FALSE); post_oc
tukeyShannonStage <- as.data.frame(post_oc$ReproductiveStage)
write.csv(tukeyShannonStage, "Results/tukeyShannonStage.csv")
```

Non-parametric tests & Post-hoc tests

```{r non-para}
# Chao1
kruskal.test(chao1~ReproductiveStage, data=metadataStageFilt)
# Shannon
kruskal.test(alphadiv~ReproductiveStage, data=metadataStageFilt)
```

Linear-mixed models

```{r linear mixed model}
# Chao1
fit_chao1 <- lmer(chao1~ ReproductiveStage + (1 | INDIVIDUAL), data=metadataStageFilt)
Anova(fit_chao1)

# Shannon
fit_shannon <- lmer(alphadiv~ ReproductiveStage + (1 | INDIVIDUAL),data=metadataStageFilt)
anova(fit_shannon)
```

### Prevalence filtering

A useful next step is to explore feature prevalence in the dataset, which we will define here as the number of samples in which a taxa appears at least once. (from f1000 paper)

```{r}
# Compute prevalence of each feature, store as data.frame
prevdf <- apply(X = otu_table(psStage),
                 MARGIN = ifelse(taxa_are_rows(psStage), yes = 1, no = 2),
                 FUN = function(x){sum(x > 0)})
# Add taxonomy and total read counts to this data.frame
prevdf <- data.frame(Prevalence = prevdf,
                      TotalAbundance = taxa_sums(psStage),
                      tax_table(psStage))
```

Are there phyla that are comprised of mostly low-prevalence features? Compute the total and average prevalences of the features in each phylum.

```{r}
plyr::ddply(prevdf, "Phylum", function(df1){cbind(mean(df1$Prevalence),sum(df1$Prevalence))})
```

```{r}
# Define phyla to filter
filterPhyla = c("Deferribacteres", "Dependentiae", "Entotheonellaeota", "Euryarchaeota", "Fibrobacteres", "Hydrogenedentes", "Lentisphaerae", "Omnitrophicaeota", "Synergistetes", "Rokubacteria", "Spirochaetes", "Tenericutes")

# Filter entries with low prevalence of Phylum.
ps1 <- subset_taxa(psStage, !Phylum %in% filterPhyla)
ps1 #14894 taxa and 176 samples
psStage <- ps1
```

Prevalence Filtering

```{r}
# Subset to the remaining phyla
prevdf1 <- subset(prevdf, Phylum %in% get_taxa_unique(psStage, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(psStage),color=Phylum)) +
  # Include a guess for parameter
    geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + 
    geom_point(size = 2, alpha = 0.7) +
    scale_x_log10() +
    xlab("Total Abundance") + 
    ylab("Prevalence [Frac. Samples]") +
    facet_wrap(~Phylum) + 
    theme(legend.position="none")
```

```{r}
#  Define prevalence threshold as 5% of total samples
prevalenceThreshold <- 0.05 * nsamples(psStage)
prevalenceThreshold

# Execute prevalence filter, using `prune_taxa()` function
keepTaxa <- rownames(prevdf1)[(prevdf1$Prevalence >= prevalenceThreshold)]
ps2 <- prune_taxa(keepTaxa, psStage)
ps2 #327 taxa and 176 samples
psStage <- ps2
saveRDS(psStage, "psStage_AllStages_prev05.RDS") #this ps object is all rep states and stages and filtered low prev phyla and filtered to a 5% prevalence threshold
```

### Agglomerate taxa

When there is known to be a lot of species or sub-species functional redundancy in a microbial community, it might be useful to agglomerate the data features corresponding to closely related taxa. Ideally we would know the functional redundancies perfectly ahead of time, in which case we would agglomerate taxa using those defined relationships and the merge_taxa() function in phyloseq. That kind of exquisite functional data is usually not available, and different pairs of microbes will have different sets of overlapping functions, complicating the matter of defining appropriate grouping criteria.

```{r}
# How many genera would be present after filtering?
length(get_taxa_unique(psStage, taxonomic.rank = "Genus"))

## [1] 143 genera

psGlomStage <- tax_glom(psStage, "Genus", NArm = TRUE)
psGlomStage #142 taxa and 313 samples
```

### Tailoring to different research questions

Abundance value transformation

It is usually necessary to transform microbiome count data to account for differences in library size, variance, scale, etc. The phyloseq package provides a flexible interface for defining new functions to accomplish these transformations of the abundance values via the transform_sample_counts() function. The first argument to this function is the phyloseq object you want to transform, and the second argument is an R function that defines the transformation. The R function is applied sample-wise, expecting that the first unnamed argument is a vector of taxa counts in the same order as the phyloseq object. Additional arguments are passed on to the function specified in the second argument, providing an explicit means to include pre-computed values, previously defined parameters/thresholds, or any other object that might be appropriate for computing the transformed values of interest.

#### Function for plotting abundance according to reproductive state stage

```{r}
plot_abundance_Status <- function(physeq,title = "",
			     Facet = "Phylum", Color = "Phylum"){
  # Arbitrary subset, based on Phylum, for plotting
  p1f <- subset_taxa(physeq, Phylum %in% c("Firmicutes"))
  mphyseq <- psmelt(p1f)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "ReproductiveStage",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
    geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}
```

#### Plotting abundance according to reproductive state

```{r}
# Transform to relative abundance. Save as new object.
psGlomRa <- transform_sample_counts(psGlomStage, function(x){x / sum(x)})

plotBefore <- plot_abundance_Status(psGlomStage,"")
plotAfter <- plot_abundance_Status(psGlomRa,"")
# Combine each plot into one graphic.
grid.arrange(nrow = 2, plotBefore, plotAfter)
```

```{r}
summary(metadataStageFilt)

metadataStageFilt$RepStateStage <- factor(metadataStageFilt$RepStateStage, levels = c("PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3")) #changing the order of the levels of rep stage from alphabetical to the order we want them in the plots

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "grey42") #colorblind friendly palette

betaDivPCoAStage <- ggplot(metadataStageFilt, aes(PCoA1, PCoA2, color = RepStateStage)) +
                    geom_point(size = 3) +
                    labs(x = "\nPCoA1 [20.2% variance]", y = "PCoA2 [8.42% variance]\n") +
                    sscale_fill_manual(values = c("goldenrod1", "darkslategray4", "olivedrab4")) + +
                    #scale_fill_discrete(labels = c("Pregnancy Stage 1: 0-52 days", "Pregnancy Stage 2: 53-104 days", "Pregnancy Stage 3: 105-157 days", "Nursing Stage 1: 0-121 days", "Nursing Stage 2: 122-242 days", "Nursing Stage 3: 243-365 days"))#filling in the rep stages with cb friendly colors
                    theme_bw() + #removing the gray grid in the background
                    stat_ellipse() +
                    theme(text = element_text(size = 14))

betaDivIndStage <- betaDivPCoAStage +
                   facet_wrap(~INDIVIDUAL)
```

### Beta-diversity (aka community structure/composition)

*PERMANOVA with adonis function
What is the model we want to test?
Many models can be statistically accurate/robust but few are biologically relevant.
Make sure to base your model on biologically relevant question.
Option with repeated measures from many individuals (time-series)

```{r betadiv}
# Create function geo means for Variance Stabilizing Transformation
gm_mean <- function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}

# Variance Stabilizing Transformation (REP_STATE)
test.phyloseq.dds<-phyloseq_to_deseq2(psStage,~ReproductiveStage)
test.phyloseq.dds <- estimateSizeFactors(test.phyloseq.dds, geoMeans = apply(counts(test.phyloseq.dds), 1, gm_mean))
vst.blind <- DESeq2::varianceStabilizingTransformation(test.phyloseq.dds, blind=TRUE)
vst.blind.Mat <- SummarizedExperiment::assay(vst.blind) # Extract transformed OTU table
vst.blind.Mat<-t(vst.blind.Mat)
vst.blind.Mat[which(vst.blind.Mat<0)]<-0
dists <- dist(t(assay(vst.blind)))

# Computing Bray-Curtis Dissimilarities and PCoA
comm.vst.blind.Mat <- vegdist(vst.blind.Mat, "bray")
PCoA.comm.vst.blind.Mat<-capscale(comm.vst.blind.Mat~1,distance="bray")
PCoA.comm.vst.blind.Mat$CA$eig[1:3]/sum(PCoA.comm.vst.blind.Mat$CA$eig)
PCoA.comm.vst.blind.Mat #this will re-order rownames to be alphabetic, which is not the way they are in the metadata csv. you will need to ensure the metadata file and this object have the same rownames before proceedingto plotting or linear models
eig <- PCoA.comm.vst.blind.Mat$CA$eig

# Portion of total vraiation in community structure explained by each of the main three components
eig[1]/sum(abs(eig)) #0.2058614 
eig[2]/sum(abs(eig)) #0.08953513 
eig[3]/sum(abs(eig)) #0.06394909

# Save scores in dataset tables
mdTest <- metadataStageFilt %>% #ensure that the df is ordered by SAMPLE_ID
          arrange(SAMPLE_ID)
metadataStageFilt <- mdTest

row.names(metadataStageFilt)<-row.names(scores(PCoA.comm.vst.blind.Mat)$sites) 
metadataStageFilt$PCoA1<-scores(PCoA.comm.vst.blind.Mat)$sites[,1]
metadataStageFilt$PCoA2<-scores(PCoA.comm.vst.blind.Mat)$sites[,2]

# PERMANOVA
permanovaMulti<-adonis(comm.vst.blind.Mat ~ ReproductiveStage + dietType + MONTH + INDIVIDUAL + Rainfall, data=metadataStageFilt, permutations = 2000)
permanova_betaDiv_stage <- as.data.frame(permanovaMulti$aov.tab)
write.csv(permanova_betaDiv_stage, "Results/permanova_betaDiv_stage.csv")
```

### PCoA with ggplot2

Let's visualize beta-diversity in a figure using PCoA with Bray-Curtis distances. 

```{r}
summary(metadataStageFilt)

metadataStageFilt$ReproductiveStages <- factor(metadataStageFilt$ReproductiveStatus, levels = c("Cycling_Pre_Conception", "PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3", "Cycling_PostWeaning")) #changing the order of the levels of rep satus from alphabetical to the order we want them in the plots

colorStage <- c("goldenrod4", "slategray2", "darkslategray4", "darkslategray", "darkgreen", "darkolivegreen3", "olivedrab4", "goldenrod1")

betaDivPCoAStage <- ggplot(metadataStageFilt, aes(PCoA1, PCoA2, color = ReproductiveStage)) +
                    geom_point(size = 3) +
                    labs(x = "\nPCoA1 [20.6% variance]", y = "PCoA2 [8.95% variance]\n") +
                    scale_color_manual(values = colorStage, labels = c("Cycling (Pre-conception)", "Pregnancy Stage 1", "Pregnancy Stage 2", "Pregnancy Stage 3", "Nursing Stage 1", "Nursing Stage 2", "Nursing Stage 3", "Cycling (Post-weaning)")) +
                    theme_minimal() + 
                    stat_ellipse() +
                    theme(text = element_text(size = 14),
                          legend.title = element_blank()); betaDivPCoAStage

ggsave("figure_betaDivPCoAStage.pdf", plot = betaDivPCoAStage, width = 8, height = 6)
```

### Top Ten genera across stages

```{r top genera}
GF_comm<-as.matrix(t(otu_table(psGlomRa, taxa_are_rows=FALSE))) #using agglomerated taxa
dim(GF_comm) #142 176
rel_abun_GF<-sweep(GF_comm, 2, apply(GF_comm,2,sum), `/`)
dim(rel_abun_GF)  #142 176
apply(rel_abun_GF,2,sum)
dim(rel_abun_GF)[1]->t
apply(rel_abun_GF,1,sum)
order(apply(rel_abun_GF,1,sum))[(t-9):t]
top10_asvs_GF<-names(apply(rel_abun_GF,1,sum)[order(apply(rel_abun_GF,1,sum))[(t-9):t]])
taxa[top10_asvs_GF,]->top10_taxa_GF
row.names(top10_taxa_GF)<-c(length(row.names(top10_taxa_GF)):1)
paste("asv_",row.names(top10_taxa_GF),sep="")->row.names(top10_taxa_GF)
top10_taxa_GF
# Test for changes in relative abundance in dominant taxa
rel_abun_top10_asvs<-rel_abun_GF[top10_asvs_GF,]
row.names(rel_abun_top10_asvs)<-row.names(top10_taxa_GF)
rel_abun_top10_asvs<-t(rel_abun_top10_asvs)
rel_abun_top10_asvs<-as.data.frame(rel_abun_top10_asvs)
rel_abun_top10_asvs$SAMPLE_ID<-row.names(rel_abun_top10_asvs)
metadataStageFilt$ReproductiveStage[as.factor(row.names(rel_abun_top10_asvs))]->rel_abun_top10_asvs$ReproductiveStage
long_rel_abun_top10_asvs<-tidyr::gather(rel_abun_top10_asvs, key=SAMPLE_ID, value=rel_abund, asv_10:asv_1)
dim(long_rel_abun_top10_asvs)
colnames(long_rel_abun_top10_asvs)[2]<-"asv_ID"
long_rel_abun_top10_asvs$plot_ID<-paste(long_rel_abun_top10_asvs$asv_ID,long_rel_abun_top10_asvs$ReproductiveStage,sep="")
top10df <- as.data.frame(top10_taxa_GF)
top10df$asv_ID <- rownames(top10df)
# Creating log10 column in long_rel_abun_top10_asvs
testLogDf <- long_rel_abun_top10_asvs %>%
             mutate(log10_rel_abund = log10(rel_abund))
for (i in 1:10){
  print(colnames(rel_abun_top10_asvs[i]))
  print(kruskal.test(rel_abun_top10_asvs[,i] ~ ReproductiveStage, data=rel_abun_top10_asvs))
  #print(dunnTest(rel_abun_top10_asvs[,i] ~ REP_STATE, data=rel_abun_top10_asvs, method="bh"))
}

limitsX2 <- c("asv_1", "asv_2", "asv_3", "asv_4", "asv_5", "asv_6", "asv_7", "asv_8", "asv_9", "asv_10")
breaksX2 <- c("asv_1", "asv_2", "asv_3", "asv_4", "asv_5", "asv_6", "asv_7", "asv_8", "asv_9", "asv_10")
labelsX2 <-  c("Streptococcus", "Bifidobacterium","Rothia","Lachnoclostridium", "Megamonas", "Collinsella",  "Bacteroides", "Escherichia/\nShigella", "Enterococcus", "Anaerobiospirillum")

colorStage <- c("goldenrod4", "slategray2", "darkslategray4", "darkslategray", "darkgreen", "darkolivegreen3", "olivedrab4", "goldenrod1")

p3<-ggplot(long_rel_abun_top10_asvs, aes(plot_ID,rel_abund*100, fill = ReproductiveStage))+theme_minimal()+
  geom_boxplot()+
  #scale_x_discrete(limits = limitsX2,
  #                 labels = labelsX2,
  #                 breaks = breaksX2) +
  xlab("")+ylab("Relative Abundance (%)\n")+
  theme(axis.text.x  = element_text(size=11, color="black", angle=90, vjust = 0.6, hjust = 1, face = "italic"),
        axis.text.y  = element_text(size=11, color="black"),
        axis.title.x  = element_text(size=14, color="black"),
        axis.title.y  = element_text(size=14, color="black"),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
        scale_fill_manual(values = colorStage, labels = c("Cycling (Pre-conception)", "Pregnancy Stage 1", "Pregnancy Stage 2", "Pregnancy Stage 3", "Nursing Stage 1", "Nursing Stage 2", "Nursing Stage 3", "Cycling (Post-weaning)"));p3
```


### Phyloseq to DESeq2 for differential abundance

The function phyloseq_to_deseq2 converts  phyloseq-format microbiome data into a DESeqDataSet with dispersions estimated, using the experimental design formula, also shown (the ~REP_STATE term). Note: The default multiple-inference correction is Benjamini-Hochberg, and occurs within the DESeq function.

#### Exploring differential abundance 

Since we have a variable of interest with >2 levels, and since we are interested in specific changes between different reproductive states, we can use "contrasts" in DESeq2 to explore log fold changes. From the DESeq2 vignette:

"A contrast is a linear combination of estimated log2 fold changes, which can be used to test if differences between groups are equal to zero. The simplest use case for contrasts is an experimental design containing a factor with three levels, say A, B and C. Contrasts enable the user to generate results for all 3 possible differences: log2 fold change of B vs A, of C vs A, and of C vs B. The contrast argument of results function is used to extract test results of log2 fold changes of interest."

```{r}
psStage <- readRDS("Robjects/psStage_prev05.RDS")
ps.dSeq <- phyloseq_to_deseq2(psStage, ~ReproductiveStage) #using unagglomerated ps1 object which includes all taxa except for low prevalence phyla (controls are already filtered out)
ps.dSeq <- estimateSizeFactors(ps.dSeq, geoMeans = apply(counts(ps.dSeq), 1, gm_mean)) #because we have many ASVs that do not appear in all samples, we have to use variance stabilized data to caluculate and visualize differential abundance 
ps.dSeq <- estimateDispersions(ps.dSeq)
ps.dSeq.vst <- getVarianceStabilizedData(ps.dSeq)
dim(ps.dSeq.vst)

psVST <- psStage #psVST is now the phyloseq object with the variance transformed counts
saveRDS(psVST, "Robjects/psVSTstage_18Sept.RDS")
#psVST <- readRDS("Robjects/psVSTstage_24July.RDS")

otu_table(psVST) <- otu_table(ps.dSeq.vst, taxa_are_rows = TRUE) # psVST variable now has the results of DESeq2 variance-stabilization of counts instead of the original counts.

dds.ps <- DESeq(ps.dSeq, test="Wald", fitType = "parametric") 
res <- results(dds.ps) #now we can create contrasts and look at other results in the results table 


```

### Creating results tables for genera

Cycling (Pre-conception) to Pregnancy Stage 1

```{r Cycling (Pre-conception) vs Preg1}
res1 <- results(dds.ps, contrast = c("ReproductiveStage", "PregnancyStage1", "Cycling_Pre_Conception")) 
res1 <- res1[order(res1$padj, na.last=NA), ]
alpha <- 0.01
sigtab1 <- res1[(res1$padj < alpha), ]
sigtab1 <- cbind(as(sigtab1, "data.frame"), as(tax_table(psVST)[rownames(sigtab1), ], "matrix"))
head(sigtab1)

write.csv(sigtab1, "Results/DiffAbundPreg1vCycPre.csv")
sigtab1 <- read.csv("Results/DiffAbundPreg1vCycPre.csv")

sigtabgen1 <- subset(sigtab1, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen1$log2FoldChange, sigtabgen1$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen1$Phylum <- factor(as.character(sigtabgen1$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen1$log2FoldChange, sigtabgen1$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen1$Genus <- factor(as.character(sigtabgen1$Genus), levels=names(x))

cols <- c("Firmicutes" = "lightcoral", "Actinobacteria" = "#E69F00", "Proteobacteria" = "#56B4E9", "Bacteroidetes" = "blue")

plot1 <- ggplot(sigtabgen1, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Cycling (Pre-conception)\nto Pregnancy Stage 1") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank(),
                      axis.title.x = element_blank()); plot1
```

Pregnancy Stage 1 to Pregnancy Stage 2

```{r Preg2  vs Preg1}
res2 <- results(dds.ps, contrast = c("ReproductiveStage", "PregnancyStage2", "PregnancyStage1")) 
res2 <- res2[order(res2$padj, na.last=NA), ]
alpha <- 0.01
sigtab2 <- res2[(res2$padj < alpha), ]
sigtab2 <- cbind(as(sigtab2, "data.frame"), as(tax_table(psVST)[rownames(sigtab2), ], "matrix"))
head(sigtab2)

write.csv(sigtab2, "Results/DiffAbundPreg2vPreg1.csv")
sigtab2 <- read.csv("Results/DiffAbundPreg2vPreg1.csv")

sigtabgen2 <- subset(sigtab2, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen2$log2FoldChange, sigtabgen2$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen2$Phylum <- factor(as.character(sigtabgen2$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen2$log2FoldChange, sigtabgen2$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen2$Genus <- factor(as.character(sigtabgen2$Genus), levels=names(x))

plot2 <- ggplot(sigtabgen2, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Pregnancy Stage 1\nto Pregnancy Stage 2") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank(),
                      axis.title.x = element_blank()); plot2
```

Pregnancy Stage 2 to Pregnancy Stage 3

```{r Preg3 vs Preg2}
res3 <- results(dds.ps, contrast = c("ReproductiveStage", "PregnancyStage3", "PregnancyStage2")) 
res3 <- res3[order(res3$padj, na.last=NA), ]
alpha <- 0.01
sigtab3 <- res3[(res3$padj < alpha), ]
sigtab3 <- cbind(as(sigtab3, "data.frame"), as(tax_table(psVST)[rownames(sigtab3), ], "matrix"))
head(sigtab3)

write.csv(sigtab3, "Results/DiffAbundPreg3vPreg2.csv")
sigtab3 <- read.csv("Results/DiffAbundPreg3vPreg2.csv")

sigtabgen3 <- subset(sigtab3, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen3$log2FoldChange, sigtabgen3$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen3$Phylum <- factor(as.character(sigtabgen3$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen3$log2FoldChange, sigtabgen3$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen3$Genus <- factor(as.character(sigtabgen3$Genus), levels=names(x))

cols <- c("Firmicutes" = "#999999", "Actinobacteria" = "#E69F00", "Proteobacteria" = "#56B4E9")

plot3 <- ggplot(sigtabgen3, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Pregnancy Stage 2\nto Pregnancy Stage 3") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank(),
                      axis.title.x = element_blank()); plot3
```

Pregnancy Stage 3 to Nursing Stage 1

```{r Nurse1 vs Preg3}
res4 <- results(dds.ps, contrast = c("ReproductiveStage", "NursingStage1", "PregnancyStage3")) 
res4 <- res4[order(res4$padj, na.last=NA), ]
alpha <- 0.01
sigtab4 <- res4[(res4$padj < alpha), ]
sigtab4 <- cbind(as(sigtab4, "data.frame"), as(tax_table(psVST)[rownames(sigtab4), ], "matrix"))
head(sigtab4)

write.csv(sigtab4, "Results/DiffAbundNurse1vsPreg3.csv")
sigtab4 <- read.csv("Results/DiffAbundNurse1vsPreg3.csv")

sigtabgen4 <- subset(sigtab4, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen4$log2FoldChange, sigtabgen4$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen4$Phylum <- factor(as.character(sigtabgen4$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen4$log2FoldChange, sigtabgen4$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen4$Genus <- factor(as.character(sigtabgen4$Genus), levels=names(x))

plot4 <- ggplot(sigtabgen4, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Pregnancy Stage 3\nto Nursing Stage 1") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank(),
                      axis.title.x = element_blank()); plot4
```

Nursing Stage 1 to Nursing Stage 2

```{r Nurse2 vs Nurse1}
res5 <- results(dds.ps, contrast = c("ReproductiveStage", "NursingStage2", "NursingStage1")) 
res5 <- res5[order(res5$padj, na.last=NA), ]
alpha <- 0.01
sigtab5 <- res5[(res5$padj < alpha), ]
sigtab5 <- cbind(as(sigtab5, "data.frame"), as(tax_table(psVST)[rownames(sigtab5), ], "matrix"))
head(sigtab5)

write.csv(sigtab5, "Results/DiffAbundNurse2vsNurse1.csv")
sigtab5 <- read.csv("Results/DiffAbundNurse2vsNurse1.csv")

sigtabgen5 <- subset(sigtab5, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen5$log2FoldChange, sigtabgen5$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen5$Phylum <- factor(as.character(sigtabgen5$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen5$log2FoldChange, sigtabgen5$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen5$Genus <- factor(as.character(sigtabgen5$Genus), levels=names(x))

plot5 <- ggplot(sigtabgen5, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Nursing Stage 1\nto Nursing Stage 2") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank(),
                      axis.title.x = element_blank()); plot5
```

Nursing Stage 2 to Nursing Stage 3

```{r Nurse3 vs Nurse2}
res6 <- results(dds.ps, contrast = c("ReproductiveStage", "NursingStage3", "NursingStage2")) 
res6 <- res6[order(res6$padj, na.last=NA), ]
alpha <- 0.01
sigtab6 <- res6[(res6$padj < alpha), ]
sigtab6 <- cbind(as(sigtab6, "data.frame"), as(tax_table(psVST)[rownames(sigtab6), ], "matrix"))
head(sigtab6)

write.csv(sigtab6, "Results/DiffAbundNurse3vsNurse2.csv")
sigtab6 <- read.csv("Results/DiffAbundNurse3vsNurse2.csv")

sigtabgen6 <- subset(sigtab6, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen6$log2FoldChange, sigtabgen6$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen6$Phylum <- factor(as.character(sigtabgen6$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen6$log2FoldChange, sigtabgen6$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen6$Genus <- factor(as.character(sigtabgen6$Genus), levels=names(x))

plot6 <- ggplot(sigtabgen6, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Nursing Stage 2\nto Nursing Stage 3") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank()); plot6
```

Nursing Stage 3 to Cycling Post-Weaning

```{r Nurse3 vs Nurse2}
res7 <- results(dds.ps, contrast = c("ReproductiveStage", "Cycling_PostWeaning", "NursingStage3")) 
res7 <- res7[order(res7$padj, na.last=NA), ]
alpha <- 0.01
sigtab7 <- res7[(res7$padj < alpha), ]
sigtab7 <- cbind(as(sigtab7, "data.frame"), as(tax_table(psVST)[rownames(sigtab7), ], "matrix"))
head(sigtab7)

write.csv(sigtab7, "Results/DiffAbundCycPostvsNurse3.csv")
sigtab7 <- read.csv("Results/DiffAbundCycPostvsNurse3.csv")

sigtabgen7 <- subset(sigtab7, !is.na(Genus))
# Phylum order
x <- tapply(sigtabgen7$log2FoldChange, sigtabgen7$Phylum, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen7$Phylum <- factor(as.character(sigtabgen7$Phylum), levels=names(x))
# Genus order
x <- tapply(sigtabgen7$log2FoldChange, sigtabgen7$Genus, function(x) max(x))
x <- sort(x, TRUE)
sigtabgen7$Genus <- factor(as.character(sigtabgen7$Genus), levels=names(x))

plot7 <- ggplot(sigtabgen7, aes(y=Genus, x=log2FoldChange, color=Phylum)) + 
                geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
                geom_point(size=3) + 
                xlim(-50, 50) +
                scale_color_manual(values = cols) +
                theme_minimal() +
                theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5), 
                      axis.text.y = element_text(face = "italic")) +
                ggtitle("Nursing Stage 3\nto Cycling (Post-Weaning)") +
                theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5),
                      legend.position = "None",
                      axis.title.y = element_blank()); plot7
```

Combining the DESeq2 plots

```{r}
plot1.legend <- get_legend(plot1) #getting legend from the first plot

logChangeCombinedPlot <- ggarrange(plot1, plot2, plot3, plot4, plot5, plot6, plot7,
                                   labels = c("A", "B", "C", "D", "E", "F", "G"),
                                   ncol = 2, nrow = 4, 
                                   common.legend = TRUE, 
                                   legend.grob = plot1.legend, 
                                   legend = "bottom", 
                                   align = "v"); logChangeCombinedPlot

ggsave("logChangeCombinedPlot.pdf", plot = logChangeCombinedPlot, width = 9, height = 11)
```

Creating a results DF 

```{r}
res1DF <- read.csv("Results/DiffAbundPreg1vCycPre.csv")
res1DF <- res1DF %>%
         mutate(Comparison = "CycPreConception_versus_PregnancyStage1")

res2DF <- read.csv("Results/DiffAbundPreg2vPreg1.csv")
res2DF <- res2DF %>%
         mutate(Comparison = "PregnancyStage2_versus_PregnancyStage1")

res3DF <- read.csv("Results/DiffAbundPreg3vPreg2.csv")
res3DF <- res3DF %>%
         mutate(Comparison = "PregnancyStage3_versus_PregnancyStage2")

res4DF <- read.csv("Results/DiffAbundNurse1vsPreg3.csv")
res4DF <- res4DF %>%
         mutate(Comparison = "NursingStage1_versus_PregnancyStage3")

res5DF <- read.csv("Results/DiffAbundNurse2vsNurse1.csv")
res5DF <- res5DF %>%
         mutate(Comparison = "NursingStage2_versus_NursingStage1")

res6DF <- read.csv("Results/DiffAbundNurse3vsNurse2.csv")
res6DF <- res6DF %>%
         mutate(Comparison = "NursingStage3_versus_NursingStage2")

res7DF <- read.csv("Results/DiffAbundCycPostvsNurse3.csv")
res7DF <- res7DF %>%
         mutate(Comparison = "CycPostWean_versus_NursingStage3")

diffAbundRes <- rbind(res1DF,res2DF,res3DF,res4DF,res5DF,res6DF,res7DF)

diffAbundRes <- diffAbundRes %>%
                filter(!is.na(Genus))

write.csv(diffAbundRes, "Results/diffAbundConcatResults27July.csv")

diffAbundRes <- read.csv("Results/diffAbundConcatResults27July.csv")
```


```{r}
ps.dSeq.phyla <- phyloseq_to_deseq2(phyloGlom, ~ReproductiveStage) #using unagglomerated ps1 object which includes all taxa except for low prevalence phyla (controls are already filtered out)
ps.dSeq.phyla <- estimateSizeFactors(ps.dSeq.phyla, geoMeans = apply(counts(ps.dSeq.phyla), 1, gm_mean)) #because we have many ASVs that do not appear in all samples, we have to use variance stabilized data to caluculate and visualize differential abundance 
ps.dSeq.phyla <- estimateDispersions(ps.dSeq.phyla)
ps.dSeq.phyla.vst <- getVarianceStabilizedData(ps.dSeq.phyla)
dim(ps.dSeq.phyla.vst)

psVSTphyla <- phyloGlom #psVST is now the phyloseq object with the variance transformed counts
saveRDS(psVSTphyla, "Robjects/psVSTstagePhyla_24July.RDS")

otu_table(psVSTphyla) <- otu_table(ps.dSeq.phyla.vst, taxa_are_rows = TRUE) # psVST variable now has the results of DESeq2 variance-stabilization of counts instead of the original counts.

dds.ps.phyla <- DESeq(ps.dSeq.phyla, test="Wald", fitType = "parametric") 
resPhyla <- results(dds.ps.phyla) #now we can create contrasts and look at other results in the results table 
```





### Phyla ratios visualization

Creating a phylum object 

```{r}
phyloGlom = tax_glom(psStage, "Phylum", NArm = TRUE) #13 taxa and 176 samples
phyloGlomRA <- transform_sample_counts(phyloGlom, function(x){x / sum(x)})

plotBefore <- plot_abundance_Status(phyloGlomRA,"")
plotAfter <- plot_abundance_Status(phyloGlomRA,"")
# Combine each plot into one graphic.
grid.arrange(nrow = 2, plotBefore, plotAfter)
```

Top phyla

```{r top genera}
Phyla_comm<-as.matrix(t(otu_table(phyloGlomRA, taxa_are_rows=FALSE))) #using agglomerated taxa
dim(Phyla_comm) #142 176
rel_abun_phyla<-sweep(Phyla_comm, 2, apply(Phyla_comm,2,sum), `/`)
dim(rel_abun_phyla)  #142 176
apply(rel_abun_phyla,2,sum)
dim(rel_abun_phyla)[1]->t
apply(rel_abun_phyla,1,sum)
order(apply(rel_abun_phyla,1,sum))[(t-9):t]
top10_phyla<-names(apply(rel_abun_phyla,1,sum)[order(apply(rel_abun_phyla,1,sum))[(t-9):t]])
taxa[top10_phyla,]->top10_taxa_phyla
row.names(top10_taxa_phyla)<-c(length(row.names(top10_taxa_phyla)):1)
paste("phylum_",row.names(top10_taxa_phyla),sep="")->row.names(top10_taxa_phyla)
top10_taxa_phyla
# Test for changes in relative abundance in dominant taxa
rel_abun_top10_phyla<-rel_abun_phyla[top10_phyla,]
row.names(rel_abun_top10_phyla)<-row.names(top10_taxa_phyla)
rel_abun_top10_phyla<-t(rel_abun_top10_phyla)
rel_abun_top10_phyla<-as.data.frame(rel_abun_top10_phyla)
rel_abun_top10_phyla$SAMPLE_ID<-row.names(rel_abun_top10_phyla)
metadataStageFilt$ReproductiveStage[as.factor(row.names(rel_abun_top10_phyla))]->rel_abun_top10_phyla$ReproductiveStage
long_rel_abun_top10_phyla<-tidyr::gather(rel_abun_top10_phyla, key=SAMPLE_ID, value=rel_abund, phylum_10:phylum_1)
dim(long_rel_abun_top10_phyla)
colnames(long_rel_abun_top10_phyla)[2]<-"phylum_ID"
long_rel_abun_top10_phyla$plot_ID<-paste(long_rel_abun_top10_phyla$asv_ID,long_rel_abun_top10_phyla$ReproductiveStage,sep="")
top10df_phyla <- as.data.frame(top10_taxa_phyla)
top10df_phyla$asv_ID <- rownames(top10df_phyla)

for (i in 1:10){
  print(colnames(rel_abun_top10_phyla[i]))
  print(kruskal.test(rel_abun_top10_phyla[,i] ~ ReproductiveStage, data=rel_abun_top10_phyla))
  #print(dunnTest(rel_abun_top10_asvs[,i] ~ REP_STATE, data=rel_abun_top10_asvs, method="bh"))
}

limitsX2 <- c("phylum_1", "phylum_2", "phylum_3", "phylum_4", "phylum_5", "phylum_6", "phylum_7", "phylum_8", "phylum_9", "phylum_10")
breaksX2 <- c("phylum_1", "phylum_2", "phylum_3", "phylum_4", "phylum_5", "phylum_6", "phylum_7", "phylum_8", "phylum_9", "phylum_10")
labelsX2 <-  c("Firmicutes", "Actinobacteria","Proteobacteria","Bacteroidetes", "Epsilonbacteraeota", "Fusobacteria",  "Thaumarchaeota", "Acidobacteria", "Verrucomicrobia", "Chloroflexi")

colorStage <- c("goldenrod4", "slategray2", "darkslategray4", "darkslategray", "darkgreen", "darkolivegreen3", "olivedrab4", "goldenrod1")

phylaPlot<-ggplot(long_rel_abun_top10_phyla, aes(phylum_ID,rel_abund*100, fill = ReproductiveStage))+theme_minimal()+
  geom_boxplot()+
  scale_x_discrete(limits = limitsX2,
                   labels = labelsX2,
                   breaks = breaksX2) +
  xlab("")+ylab("Relative Abundance (%)\n")+
  theme(axis.text.x  = element_text(size=11, color="black", angle=90, vjust = 0.6, hjust = 1, face = "italic"),
        axis.text.y  = element_text(size=11, color="black"),
        axis.title.x  = element_text(size=14, color="black"),
        axis.title.y  = element_text(size=14, color="black"),
        legend.title = element_blank(),
        axis.ticks = element_blank()) +
        scale_fill_manual(values = colorStage, labels = c("Cycling (Pre-conception)", "Pregnancy Stage 1", "Pregnancy Stage 2", "Pregnancy Stage 3", "Nursing Stage 1", "Nursing Stage 2", "Nursing Stage 3", "Cycling (Post-weaning)"));phylaPlot

long_rel_abun_top10_phyla_BACT_FIRM <- long_rel_abun_top10_phyla %>%
                                       filter(phylum_ID %in% c("phylum_1", "phylum_4"))

limitsX3 <- c("phylum_1", "phylum_4")
breaksX3 <- c("phylum_1", "phylum_4")
labelsX3 <-  c("Firmicutes", "Bacteroidetes")

phylaPlotBactFirm<-ggplot(long_rel_abun_top10_phyla_BACT_FIRM, aes(ReproductiveStage,rel_abund*100, fill = phylum_ID))+theme_minimal()+
  geom_boxplot()+
  scale_x_discrete(labels = c("Cycling (Pre-conception)", "Pregnancy Stage 1", "Pregnancy Stage 2", "Pregnancy Stage 3", "Nursing Stage 1", "Nursing Stage 2", "Nursing Stage 3", "Cycling (Post-weaning)")) +
  scale_fill_manual(labels = c("Firmicutes", "Bacteroidetes"),
                    values = c("lightcoral", "blue")) +
  xlab("")+ylab("Relative Abundance (%)\n")+
  theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 1, hjust = 1),
        axis.text.y  = element_text(size=11, color="black"),
        axis.title.x  = element_text(size=14, color="black"),
        axis.title.y  = element_text(size=14, color="black"),
        legend.title = element_blank(),
        axis.ticks = element_blank()) ; phylaPlotBactFirm

ggsave(plot = phylaPlotBactFirm, "phylaPlotBactFirm.pdf", height = 8, width = 6)
        
```

Bacteroidetes/Firmicutes Ratio

```{r}
rel_abun_top10_phyla
relAbunBactFirm <- rel_abun_top10_phyla %>%
                   dplyr::select(SAMPLE_ID, ReproductiveStage, phylum_1, phylum_4)

relAbunBactFirm <- dplyr::rename(relAbunBactFirm, Firmicutes = phylum_1)
relAbunBactFirm <- dplyr::rename(relAbunBactFirm, Bacteroidetes = phylum_4)

relAbunBactFirm <- relAbunBactFirm %>%
                   mutate(Ratio = Firmicutes/Bacteroidetes)

firmBactPlot <- ggplot(relAbunBactFirm, aes(x = Firmicutes*100, y = Bacteroidetes*100, color = ReproductiveStage)) +
                       geom_point() +
                       facet_wrap(~ReproductiveStage); firmBactPlot

ratioFirmBactPlot <- ggplot(relAbunBactFirm, aes(x = ReproductiveStage, y = Ratio, fill = ReproductiveStage)) +
                            geom_boxplot() 
                            #scale_fill_discrete(values = colorStage); ratioFirmBactPlot

```


### Creating a figure tracking abundance over the course of pregnancy and nursing

Reading in psStage object and metadataStageFilt

```{r}
psVST <- readRDS("~/Desktop/PregnancyPaper2019/PregnancyMicrobiomeProject/MicrobiomeAnalysis/RObjects/psVSTstage4May.RDS") #read in the variance stabilized counts object
metadataStageFilt <- read.csv("~/Desktop/PregnancyPaper2019/PregnancyMicrobiomeProject/MicrobiomeAnalysis/RObjects/metadataStageFilt4May.csv") #read in filt metadata
```

We will use agglomerated data for the figure

```{r}
# How many genera would be present after filtering?
length(get_taxa_unique(psStage, taxonomic.rank = "Genus"))

## [1] 148 genera

psGlomStage <- tax_glom(psStage, "Genus", NArm = TRUE)
psGlomStage #147 taxa and 139 samples
```

```{r}
GF_comm<-as.matrix(t(otu_table(psGlomStage, taxa_are_rows=FALSE))) #using agglomerated taxa
dim(GF_comm) #147 139
rel_abun_GF<-sweep(GF_comm, 2, apply(GF_comm,2,sum), `/`)
dim(rel_abun_GF) #147 139
apply(rel_abun_GF,2,sum)
dim(rel_abun_GF)[1]->t
apply(rel_abun_GF,1,sum)
order(apply(rel_abun_GF,1,sum))
order(apply(rel_abun_GF,1,sum))[length(t):t]
asvsStage<-names(apply(rel_abun_GF,1,sum)[order(apply(rel_abun_GF,1,sum))])
asvsStage<-names(apply(rel_abun_GF,1,sum)[order(apply(rel_abun_GF,1,sum))[length(t):t]])

taxa[asvsStage,]->asvsStage
row.names(asvsStage)<-c(length(row.names(asvsStage)):1)
paste("asv_",row.names(asvsStage),sep="")->row.names(asvsStage)
asvsStage
asvsStage_df <- as.data.frame(asvsStage)

asvsStage_df <- asvsStage_df[rev(rownames(asvsStage_df)), ] #reversing the order
rownames(rel_abun_GF) <- asvsStage_df$Genus #setting rownames to the genus
rel_abun_t<-t(rel_abun_GF) #transposing the df so that each sample is a row, each column is a genus, and values are the rel abundance of each genus
rel_abun_RepStage<-as.data.frame(rel_abun_t)

rel_abun_RepStage$SAMPLE_ID<-row.names(rel_abun_RepStage) #adding a column for sample id so we can join rep state stage to the df

#left joining rep state stage to rel abund table

df_sampleid_repstatestage <- metadataStageFilt %>%
                             dplyr::select(., SAMPLE_ID, RepStateStage) #filtering the metadata to just include sample id and rep state stage

rel_abun_RepStage_test <- left_join(df_sampleid_repstatestage, rel_abun_RepStage, by = "SAMPLE_ID") #joining so that we have a df of sample id, genus, and rep state stage
rel_abun_RepStage <- rel_abun_RepStage_test #saving this into the df
rel_abun_RepStage$RepStateStage <- factor(rel_abun_RepStage$RepStateStage, levels = c("PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3"))

write.csv(rel_abun_RepStage, "~/Desktop/PregnancyPaper2019/PregnancyMicrobiomeProject/MicrobiomeAnalysis/Metadata/relAbundanceByRepStage6May2020.csv")
```

Filter to genera of interest

Reading in table of genera that had a log2 fold difference

```{r}
res_df <- read.csv("~/Desktop/PregnancyPaper2019/PregnancyMicrobiomeProject/MicrobiomeAnalysis/ResultTables/diffAbundConcatResults22April.csv")
listOfGenera <- unique(res_df$Genus) ; listOfGenera
```

Preparing for plots

```{r}
breaks_RepStage = c("PregnancyStage1", "PregnancyStage2", "PregnancyStage3", "NursingStage1", "NursingStage2", "NursingStage3")
labels_RepStage = c("Pregnancy Stage 1", "Pregnancy Stage 2", "Pregnancy Stage 3", "Nursing Stage 1", "Nursing Stage 2", "Nursing Stage 3")
```


Anaerosporobacter plot

```{r}
Anaerosporobacter_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Anaerosporobacter, RepStateStage)

Anaerosporobacter_RepState_plot <-ggplot(Anaerosporobacter_RepState, aes(x = RepStateStage, y = Anaerosporobacter*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Anaerosporobacter\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Anaerosporobacter_RepState_plot
```

Xylella plot

```{r}
Xylella_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Xylella, RepStateStage)

Xylella_RepState_plot <-ggplot(Xylella_RepState, aes(x = RepStateStage, y = Xylella*100)) +
                                   geom_violin() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Xylella\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Xylella_RepState_plot
```

Clostridium_sensu_stricto_1 plot

```{r}
Clostridium_sensu_stricto_1_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Clostridium_sensu_stricto_1, RepStateStage)

Clostridium_RepState_plot <-ggplot(clostridium_RepState, aes(x = RepStateStage, y = Clostridium_sensu_stricto_1*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Clostridium sensu stricto 1\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Clostridium_RepState_plot
        
```

Klebsiella plot

```{r}
Klebsiella_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Klebsiella, RepStateStage)

Klebsiella_RepState_plot <-ggplot(Klebsiella_RepState, aes(x = RepStateStage, y = Klebsiella*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Klebsiella\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Klebsiella_RepState_plot

```

Veillonella plot

```{r}
Veillonella_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Veillonella, RepStateStage)

Veillonella_RepState_plot <-ggplot(Veillonella_RepState, aes(x = RepStateStage, y = Veillonella*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Veillonella\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Veillonella_RepState_plot
```

Anaerobiospirillum plot

```{r}
Anaerobiospirillum_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Anaerobiospirillum, RepStateStage)

Anaerobiospirillum_RepState_plot <-ggplot(Anaerobiospirillum_RepState, aes(x = RepStateStage, y = Anaerobiospirillum*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Anaerobiospirillum\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Anaerobiospirillum_RepState_plot
```

Serratia plot

```{r}
Serratia_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Serratia, RepStateStage)

Serratia_RepState_plot <-ggplot(Serratia_RepState, aes(x = RepStateStage, y = Serratia*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Serratia\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Serratia_RepState_plot


```

Gordonia plot

```{r}
Gordonia_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Gordonia, RepStateStage)

Gordonia_RepState_plot <-ggplot(Gordonia_RepState, aes(x = RepStateStage, y = Gordonia*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Gordonia\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Gordonia_RepState_plot
```

Pluralibacter plot

```{r}
Pluralibacter_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Pluralibacter, RepStateStage)

Pluralibacter_RepState_plot <-ggplot(Pluralibacter_RepState, aes(x = RepStateStage, y = Pluralibacter*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Pluralibacter\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Pluralibacter_RepState_plot
```

Alloprevotella plot

```{r}
Alloprevotella_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Alloprevotella, RepStateStage)

Alloprevotella_RepState_plot <-ggplot(Alloprevotella_RepState, aes(x = RepStateStage, y = Alloprevotella*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Alloprevotella\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Alloprevotella_RepState_plot
```

Tatumella plot

```{r}
Tatumella_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Tatumella, RepStateStage)

Tatumella_RepState_plot <-ggplot(Tatumella_RepState, aes(x = RepStateStage, y = Tatumella*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Tatumella\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Tatumella_RepState_plot
```

Enterococcus plot

```{r}
Enterococcus_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Enterococcus, RepStateStage)

Enterococcus_RepState_plot <-ggplot(Enterococcus_RepState, aes(x = RepStateStage, y = Enterococcus*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Enterococcus\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Enterococcus_RepState_plot
```

Erysipelatoclostridium plot

```{r}
Erysipelatoclostridium_RepState <- rel_abun_RepStage %>%
                        dplyr::select(SAMPLE_ID, Erysipelatoclostridium, RepStateStage)

Erysipelatoclostridium_RepState_plot <-ggplot(Erysipelatoclostridium_RepState, aes(x = RepStateStage, y = Erysipelatoclostridium*100)) +
                                   geom_boxplot() +
                                   theme_bw() +
                                   scale_x_discrete(breaks = breaks_RepStage,
                                                    labels = labels_RepStage) +
                                   xlab("") +
                                   ylab("Erysipelatoclostridium\nRelative Abundance (%)\n") +
                                   theme(axis.text.x  = element_text(size=11, color="black", angle=45, vjust = 0.95, hjust = 1),
                                         axis.text.y  = element_text(size=11, color="black"),
                                         axis.title.y  = element_text(size=14, color="black")) ;Erysipelatoclostridium_RepState_plot
```









